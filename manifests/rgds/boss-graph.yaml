apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: boss-graph
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  schema:
    apiVersion: v1alpha1
    kind: Boss
    group: game.k8s.example
    spec:
      dungeonName: string | required=true
      hp: integer | required=true
      difficulty: string | default="normal"
      monstersAlive: integer | default=1
    status:
      state: "${bossPod.metadata.labels['game.k8s.example/state']}"
      hp: "${bossPod.metadata.annotations['game.k8s.example/hp']}"

  resources:
    - id: bossPod
      template:
        apiVersion: v1
        kind: Pod
        metadata:
          name: "${schema.spec.dungeonName + '-boss'}"
          namespace: ${schema.metadata.namespace}
          labels:
            game.k8s.example/dungeon: ${schema.spec.dungeonName}
            game.k8s.example/entity: boss
            game.k8s.example/state: "${schema.spec.hp > 0 ? (schema.spec.monstersAlive == 0 ? 'ready' : 'pending') : 'defeated'}"
          annotations:
            game.k8s.example/hp: "${string(schema.spec.hp)}"
        spec:
          containers:
            - name: boss
              image: registry.k8s.io/pause:3.10
              resources:
                requests:
                  cpu: "10m"
                  memory: "16Mi"
