apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: attack-graph
spec:
  schema:
    apiVersion: v1alpha1
    kind: Attack
    group: game.k8s.example
    spec:
      dungeonName: string | required=true
      dungeonNamespace: string | default="default"
      target: string | required=true
      damage: integer | required=true
    status:
      jobStatus: "${attackJob.status.?succeeded.orValue(0) > 0 ? 'success' : 'pending'}"

  resources:
    - id: attackJob
      template:
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: ${schema.metadata.name}
          namespace: ${schema.metadata.namespace}
        spec:
          backoffLimit: 3
          ttlSecondsAfterFinished: 300
          template:
            spec:
              serviceAccountName: attack-job-sa
              restartPolicy: Never
              containers:
                - name: attacker
                  image: bitnami/kubectl:latest
                  env:
                    - name: DUNGEON
                      value: ${schema.spec.dungeonName}
                    - name: DUNGEON_NS
                      value: ${schema.spec.dungeonNamespace}
                    - name: TARGET
                      value: ${schema.spec.target}
                    - name: DAMAGE
                      value: "${string(schema.spec.damage)}"
                  command: ["/bin/bash", "-c"]
                  args:
                    - |
                      set -e
                      for i in 1 2 3 4 5; do
                        DUNGEON_JSON=$(kubectl get dungeon "$DUNGEON" -n "$DUNGEON_NS" -o json)
                        HERO_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.heroHP // 100')
                        HERO_CLASS=$(echo "$DUNGEON_JSON" | jq -r '.spec.heroClass // "warrior"')
                        HERO_MANA=$(echo "$DUNGEON_JSON" | jq -r '.spec.heroMana // 0')
                        DIFFICULTY=$(echo "$DUNGEON_JSON" | jq -r '.spec.difficulty // "normal"')
                        TAUNT_ACTIVE=$(echo "$DUNGEON_JSON" | jq -r '.spec.tauntActive // 0')
                        BACKSTAB_CD=$(echo "$DUNGEON_JSON" | jq -r '.spec.backstabCooldown // 0')
                        MODIFIER=$(echo "$DUNGEON_JSON" | jq -r '.spec.modifier // "none"')

                        # Decrement backstab cooldown each turn
                        [ "$BACKSTAB_CD" -gt 0 ] && BACKSTAB_CD=$((BACKSTAB_CD - 1))

                        MANA_PATCH=""
                        EXTRA_PATCH=""
                        CLASS_NOTE=""
                        HERO_ACTION=""
                        ENEMY_ACTION=""

                        # === MAGE HEAL ===
                        if [ "$TARGET" = "hero" ]; then
                          if [ "$HERO_CLASS" != "mage" ]; then
                            echo "Only mage can heal"; exit 1
                          fi
                          if [ "$HERO_MANA" -lt 2 ]; then
                            echo "Not enough mana (need 2, have $HERO_MANA)"; exit 1
                          fi
                          MAX_HP=80
                          HEAL=30
                          NEW_HP=$((HERO_HP + HEAL))
                          [ "$NEW_HP" -gt "$MAX_HP" ] && NEW_HP=$MAX_HP
                          HERO_MANA=$((HERO_MANA - 2))
                          HERO_ACTION="Mage heals for $((NEW_HP - HERO_HP)) HP! (Mana: $HERO_MANA)"
                          ENEMY_ACTION="No counter-attack during heal"
                          PATCH="{\"spec\":{\"heroHP\":$NEW_HP,\"heroMana\":$HERO_MANA,\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"$ENEMY_ACTION\"}}"
                          echo "$HERO_ACTION"
                          if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                            echo "Heal complete!"; exit 0
                          fi
                          echo "Conflict, retrying ($i/5)..."; sleep $i; continue
                        fi

                        # === WARRIOR TAUNT ===
                        if [ "$TARGET" = "taunt" ]; then
                          if [ "$HERO_CLASS" != "warrior" ]; then
                            echo "Only warrior can taunt"; exit 1
                          fi
                          TAUNT_ACTIVE=1
                          # Enemies still counter-attack but at reduced damage
                          MONSTER_HPS=$(echo "$DUNGEON_JSON" | jq -c '.spec.monsterHP')
                          ALIVE=$(echo "$MONSTER_HPS" | jq '[.[] | select(. > 0)] | length')
                          BOSS_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.bossHP')
                          BOSS_STATE="pending"
                          [ "$ALIVE" -eq 0 ] && [ "$BOSS_HP" -gt 0 ] && BOSS_STATE="ready"
                          TOTAL_COUNTER=0
                          if [ "$ALIVE" -gt 0 ]; then
                            case "$DIFFICULTY" in
                              easy)   MC=2 ;; normal) MC=4 ;; hard) MC=6 ;;
                            esac
                            TOTAL_COUNTER=$((ALIVE * MC))
                          fi
                          if [ "$BOSS_STATE" = "ready" ]; then
                            case "$DIFFICULTY" in
                              easy)   BC=2 ;; normal) BC=10 ;; hard) BC=15 ;;
                            esac
                            TOTAL_COUNTER=$((TOTAL_COUNTER + BC))
                          fi
                          # Taunt: 50% reduction + warrior passive 20% = 60% total reduction
                          TOTAL_COUNTER=$((TOTAL_COUNTER * 2 / 5))
                          HERO_HP=$((HERO_HP - TOTAL_COUNTER))
                          [ "$HERO_HP" -lt 0 ] && HERO_HP=0
                          HERO_ACTION="Warrior taunts! Damage reduced by 60% this round!"
                          ENEMY_ACTION="Enemies counter for $TOTAL_COUNTER reduced damage (Hero HP: $HERO_HP)"
                          PATCH="{\"spec\":{\"heroHP\":$HERO_HP,\"tauntActive\":$TAUNT_ACTIVE,\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"$ENEMY_ACTION\"}}"
                          echo "$HERO_ACTION"
                          echo "$ENEMY_ACTION"
                          if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                            echo "Taunt complete!"; exit 0
                          fi
                          echo "Conflict, retrying ($i/5)..."; sleep $i; continue
                        fi

                        # === ROGUE BACKSTAB (target ends with -backstab) ===
                        IS_BACKSTAB=false
                        REAL_TARGET="$TARGET"
                        if echo "$TARGET" | grep -q "\-backstab$"; then
                          IS_BACKSTAB=true
                          REAL_TARGET=$(echo "$TARGET" | sed 's/-backstab$//')
                          if [ "$HERO_CLASS" != "rogue" ]; then
                            echo "Only rogue can backstab"; exit 1
                          fi
                          ORIG_CD=$(echo "$DUNGEON_JSON" | jq -r '.spec.backstabCooldown // 0')
                          if [ "$ORIG_CD" -gt 0 ]; then
                            echo "Backstab on cooldown ($ORIG_CD turns)"; exit 1
                          fi
                          BACKSTAB_CD=3
                        fi

                        # Apply class damage modifier
                        EFFECTIVE_DAMAGE=$DAMAGE
                        if [ "$IS_BACKSTAB" = "true" ]; then
                          EFFECTIVE_DAMAGE=$((DAMAGE * 3))
                          CLASS_NOTE=" (Backstab 3x!)"
                        elif [ "$HERO_CLASS" = "mage" ]; then
                          if [ "$HERO_MANA" -gt 0 ]; then
                            if echo "$REAL_TARGET" | grep -q "boss"; then
                              EFFECTIVE_DAMAGE=$((DAMAGE * 3 / 2))
                              CLASS_NOTE=" (Mage critical!)"
                            fi
                            HERO_MANA=$((HERO_MANA - 1))
                            MANA_PATCH=",\"heroMana\":$HERO_MANA"
                          else
                            CLASS_NOTE=" (No mana!)"
                            EFFECTIVE_DAMAGE=$((DAMAGE / 2))
                          fi
                        elif [ "$HERO_CLASS" = "rogue" ]; then
                          EFFECTIVE_DAMAGE=$((DAMAGE * 6 / 5))
                          CLASS_NOTE=" (Rogue precision!)"
                        fi

                        # Clear taunt after a normal attack turn
                        TAUNT_ACTIVE=0

                        # Apply modifier to hero damage
                        if [ "$MODIFIER" = "curse-darkness" ]; then
                          EFFECTIVE_DAMAGE=$((EFFECTIVE_DAMAGE * 3 / 4))
                          CLASS_NOTE="$CLASS_NOTE [Curse: -25% dmg]"
                        elif [ "$MODIFIER" = "blessing-strength" ]; then
                          EFFECTIVE_DAMAGE=$((EFFECTIVE_DAMAGE * 3 / 2))
                          CLASS_NOTE="$CLASS_NOTE [Blessing: +50% dmg]"
                        elif [ "$MODIFIER" = "blessing-fortune" ]; then
                          CRIT_ROLL=$((RANDOM % 100))
                          if [ "$CRIT_ROLL" -lt 20 ]; then
                            EFFECTIVE_DAMAGE=$((EFFECTIVE_DAMAGE * 2))
                            CLASS_NOTE="$CLASS_NOTE [CRIT! 2x dmg]"
                          fi
                        fi

                        # Calculate hero's attack on target
                        if echo "$REAL_TARGET" | grep -q "boss"; then
                          OLD_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.bossHP')
                          NEW_HP=$((OLD_HP - EFFECTIVE_DAMAGE))
                          [ "$NEW_HP" -lt 0 ] && NEW_HP=0
                          # Boss counter-attack
                          case "$DIFFICULTY" in
                            easy)   COUNTER=2 ;; normal) COUNTER=10 ;; hard) COUNTER=15 ;;
                          esac
                          if [ "$NEW_HP" -gt 0 ]; then
                            # Apply modifier to boss counter
                            if [ "$MODIFIER" = "curse-fury" ]; then
                              COUNTER=$((COUNTER * 2))
                            elif [ "$MODIFIER" = "blessing-resilience" ]; then
                              COUNTER=$((COUNTER / 2))
                            fi
                            if [ "$HERO_CLASS" = "warrior" ]; then
                              COUNTER=$((COUNTER * 4 / 5))
                            elif [ "$HERO_CLASS" = "rogue" ]; then
                              DODGE_ROLL=$((RANDOM % 100))
                              if [ "$DODGE_ROLL" -lt 30 ]; then
                                COUNTER=0
                                CLASS_NOTE="$CLASS_NOTE Rogue dodged!"
                              fi
                            fi
                            HERO_HP=$((HERO_HP - COUNTER))
                          fi
                          [ "$HERO_HP" -lt 0 ] && HERO_HP=0
                          HP_PATCH="\"bossHP\":$NEW_HP"
                        else
                          IDX=$(echo "$REAL_TARGET" | grep -oE '[0-9]+$')
                          OLD_HP=$(echo "$DUNGEON_JSON" | jq -r ".spec.monsterHP[$IDX]")
                          NEW_HP=$((OLD_HP - EFFECTIVE_DAMAGE))
                          [ "$NEW_HP" -lt 0 ] && NEW_HP=0
                          HP_ARRAY=$(echo "$DUNGEON_JSON" | jq ".spec.monsterHP[$IDX] = $NEW_HP | .spec.monsterHP")
                          # Mage mana regen on kill
                          if [ "$NEW_HP" -eq 0 ] && [ "$HERO_CLASS" = "mage" ] && [ "$HERO_MANA" -lt 5 ]; then
                            HERO_MANA=$((HERO_MANA + 1))
                            MANA_PATCH=",\"heroMana\":$HERO_MANA"
                            CLASS_NOTE="$CLASS_NOTE +1 mana!"
                          fi
                          # All alive monsters counter-attack
                          case "$DIFFICULTY" in
                            easy)   COUNTER=2 ;; normal) COUNTER=4 ;; hard) COUNTER=6 ;;
                          esac
                          ALIVE=$(echo "$DUNGEON_JSON" | jq '[.spec.monsterHP[] | select(. > 0)] | length')
                          [ "$NEW_HP" -eq 0 ] && [ "$ALIVE" -gt 0 ] && ALIVE=$((ALIVE - 1))
                          TOTAL_COUNTER=$((ALIVE * COUNTER))
                          # Apply modifier to monster counter
                          if [ "$MODIFIER" = "blessing-resilience" ]; then
                            TOTAL_COUNTER=$((TOTAL_COUNTER / 2))
                          fi
                          if [ "$TOTAL_COUNTER" -gt 0 ]; then
                            if [ "$HERO_CLASS" = "warrior" ]; then
                              TOTAL_COUNTER=$((TOTAL_COUNTER * 4 / 5))
                            elif [ "$HERO_CLASS" = "rogue" ]; then
                              DODGE_ROLL=$((RANDOM % 100))
                              if [ "$DODGE_ROLL" -lt 30 ]; then
                                TOTAL_COUNTER=0
                                CLASS_NOTE="$CLASS_NOTE Rogue dodged!"
                              fi
                            fi
                            HERO_HP=$((HERO_HP - TOTAL_COUNTER))
                          fi
                          [ "$HERO_HP" -lt 0 ] && HERO_HP=0
                          HP_PATCH="\"monsterHP\":$HP_ARRAY"
                        fi

                        HERO_ACTION="Hero ($HERO_CLASS) deals $EFFECTIVE_DAMAGE damage to $REAL_TARGET (HP: $OLD_HP -> $NEW_HP)$CLASS_NOTE"

                        if echo "$REAL_TARGET" | grep -q "boss"; then
                          if [ "$NEW_HP" -gt 0 ]; then
                            ENEMY_ACTION="Boss strikes back for $COUNTER damage! (Hero HP: $HERO_HP)"
                          else
                            ENEMY_ACTION="Boss defeated!"
                          fi
                        else
                          if [ "$TOTAL_COUNTER" -gt 0 ] 2>/dev/null; then
                            ENEMY_ACTION="$ALIVE monsters counter-attack for $TOTAL_COUNTER total damage! (Hero HP: $HERO_HP)"
                          else
                            ENEMY_ACTION="No monsters left to counter-attack"
                          fi
                        fi

                        PATCH="{\"spec\":{$HP_PATCH,\"heroHP\":$HERO_HP,\"tauntActive\":$TAUNT_ACTIVE,\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"$ENEMY_ACTION\"$MANA_PATCH}}"

                        echo "$HERO_ACTION"
                        echo "$ENEMY_ACTION"

                        if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                          echo "Turn complete!"
                          exit 0
                        fi

                        echo "Conflict, retrying ($i/5)..."
                        sleep $i
                      done
                      echo "Attack failed after retries"
                      exit 1
