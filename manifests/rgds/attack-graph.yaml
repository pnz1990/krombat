apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: attack-graph
spec:
  schema:
    apiVersion: v1alpha1
    kind: Attack
    group: game.k8s.example
    spec:
      dungeonName: string | required=true
      dungeonNamespace: string | default="default"
      target: string | required=true
      damage: integer | required=true
    status:
      jobStatus: "${attackJob.status.?succeeded.orValue(0) > 0 ? 'success' : 'pending'}"

  resources:
    - id: attackJob
      template:
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: ${schema.metadata.name}
          namespace: ${schema.metadata.namespace}
        spec:
          backoffLimit: 3
          ttlSecondsAfterFinished: 300
          template:
            spec:
              serviceAccountName: attack-job-sa
              restartPolicy: Never
              containers:
                - name: attacker
                  image: bitnami/kubectl:latest
                  env:
                    - name: DUNGEON
                      value: ${schema.spec.dungeonName}
                    - name: DUNGEON_NS
                      value: ${schema.spec.dungeonNamespace}
                    - name: TARGET
                      value: ${schema.spec.target}
                    - name: DAMAGE
                      value: "${string(schema.spec.damage)}"
                  command: ["/bin/bash", "-c"]
                  args:
                    - |
                      set -e
                      for i in 1 2 3 4 5; do
                        DUNGEON_JSON=$(kubectl get dungeon "$DUNGEON" -n "$DUNGEON_NS" -o json)
                        HERO_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.heroHP // 100')
                        DIFFICULTY=$(echo "$DUNGEON_JSON" | jq -r '.spec.difficulty // "normal"')
                        CURRENT_TURN=$(echo "$DUNGEON_JSON" | jq -r '.spec.currentTurn // "hero"')
                        TURN_ROUND=$(echo "$DUNGEON_JSON" | jq -r '.spec.turnRound // 1')

                        # Only process if it's the hero's turn
                        if [ "$CURRENT_TURN" != "hero" ]; then
                          echo "Not hero's turn (current: $CURRENT_TURN), skipping"
                          exit 0
                        fi

                        # Calculate hero's attack on target
                        if echo "$TARGET" | grep -q "boss"; then
                          OLD_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.bossHP')
                          NEW_HP=$((OLD_HP - DAMAGE))
                          [ "$NEW_HP" -lt 0 ] && NEW_HP=0
                          # Boss counter-attack (hits harder)
                          case "$DIFFICULTY" in
                            easy)   COUNTER=15 ;;
                            normal) COUNTER=25 ;;
                            hard)   COUNTER=40 ;;
                          esac
                          [ "$NEW_HP" -gt 0 ] && HERO_HP=$((HERO_HP - COUNTER))
                          [ "$HERO_HP" -lt 0 ] && HERO_HP=0
                          HP_PATCH="\"bossHP\":$NEW_HP"
                        else
                          IDX=$(echo "$TARGET" | grep -oE '[0-9]+$')
                          OLD_HP=$(echo "$DUNGEON_JSON" | jq -r ".spec.monsterHP[$IDX]")
                          NEW_HP=$((OLD_HP - DAMAGE))
                          [ "$NEW_HP" -lt 0 ] && NEW_HP=0
                          HP_ARRAY=$(echo "$DUNGEON_JSON" | jq ".spec.monsterHP[$IDX] = $NEW_HP | .spec.monsterHP")
                          # All alive monsters counter-attack
                          case "$DIFFICULTY" in
                            easy)   COUNTER=5 ;;
                            normal) COUNTER=8 ;;
                            hard)   COUNTER=12 ;;
                          esac
                          ALIVE=$(echo "$DUNGEON_JSON" | jq '[.spec.monsterHP[] | select(. > 0)] | length')
                          [ "$NEW_HP" -eq 0 ] && [ "$ALIVE" -gt 0 ] && ALIVE=$((ALIVE - 1))
                          TOTAL_COUNTER=$((ALIVE * COUNTER))
                          [ "$TOTAL_COUNTER" -gt 0 ] && HERO_HP=$((HERO_HP - TOTAL_COUNTER))
                          [ "$HERO_HP" -lt 0 ] && HERO_HP=0
                          HP_PATCH="\"monsterHP\":$HP_ARRAY"
                        fi

                        # Compute next turn: cycle through alive monsters, then boss if ready, then back to hero
                        NEXT_TURN="hero"
                        NEXT_ROUND=$TURN_ROUND
                        if [ "$HERO_HP" -gt 0 ]; then
                          # Check alive monsters (using post-attack HP)
                          if echo "$TARGET" | grep -q "boss"; then
                            MONSTER_HPS=$(echo "$DUNGEON_JSON" | jq -c '.spec.monsterHP')
                          else
                            MONSTER_HPS=$(echo "$HP_ARRAY")
                          fi
                          MONSTER_COUNT=$(echo "$MONSTER_HPS" | jq 'length')
                          FOUND_ENEMY=false
                          for m in $(seq 0 $((MONSTER_COUNT - 1))); do
                            MHP=$(echo "$MONSTER_HPS" | jq ".[$m]")
                            if [ "$MHP" -gt 0 ]; then
                              NEXT_TURN="monster-$m"
                              FOUND_ENEMY=true
                              break
                            fi
                          done
                          # If no alive monsters, check boss
                          if [ "$FOUND_ENEMY" = "false" ]; then
                            if echo "$TARGET" | grep -q "boss"; then
                              BOSS_HP=$NEW_HP
                            else
                              BOSS_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.bossHP')
                            fi
                            if [ "$BOSS_HP" -gt 0 ]; then
                              NEXT_TURN="boss"
                              FOUND_ENEMY=true
                            fi
                          fi
                          # If no enemies found (or all dead), stay on hero (next round)
                          if [ "$FOUND_ENEMY" = "false" ]; then
                            NEXT_TURN="hero"
                          fi
                          # If cycling back to hero, increment round
                          if [ "$NEXT_TURN" = "hero" ] && [ "$FOUND_ENEMY" = "true" ]; then
                            NEXT_ROUND=$((TURN_ROUND + 1))
                          fi
                        fi

                        HERO_ACTION="Hero deals $DAMAGE damage to $TARGET (HP: $OLD_HP -> $NEW_HP)"

                        if echo "$TARGET" | grep -q "boss"; then
                          if [ "$NEW_HP" -gt 0 ]; then
                            ENEMY_ACTION="Boss strikes back for $COUNTER damage! (Hero HP: $HERO_HP)"
                          else
                            ENEMY_ACTION="Boss defeated!"
                          fi
                        else
                          if [ "$TOTAL_COUNTER" -gt 0 ] 2>/dev/null; then
                            ENEMY_ACTION="$ALIVE monsters counter-attack for $TOTAL_COUNTER total damage! (Hero HP: $HERO_HP)"
                          else
                            ENEMY_ACTION="No monsters left to counter-attack"
                          fi
                        fi

                        PATCH="{\"spec\":{$HP_PATCH,\"heroHP\":$HERO_HP,\"currentTurn\":\"$NEXT_TURN\",\"turnRound\":$NEXT_ROUND,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"$ENEMY_ACTION\"}}"

                        echo "$HERO_ACTION"
                        echo "$ENEMY_ACTION"

                        if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                          echo "Turn complete!"
                          exit 0
                        fi

                        echo "Conflict, retrying ($i/5)..."
                        sleep $i
                      done
                      echo "Attack failed after retries"
                      exit 1
