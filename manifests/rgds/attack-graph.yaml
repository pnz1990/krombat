apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: attack-graph
spec:
  schema:
    apiVersion: v1alpha1
    kind: Attack
    group: game.k8s.example
    spec:
      dungeonName: string | required=true
      dungeonNamespace: string | default="default"
      target: string | required=true
      damage: integer | required=true
    status:
      jobStatus: "${attackJob.status.?succeeded.orValue(0) > 0 ? 'success' : 'pending'}"

  resources:
    - id: attackJob
      template:
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: ${schema.metadata.name}
          namespace: ${schema.metadata.namespace}
        spec:
          backoffLimit: 3
          ttlSecondsAfterFinished: 300
          template:
            spec:
              serviceAccountName: attack-job-sa
              restartPolicy: Never
              containers:
                - name: attacker
                  image: bitnami/kubectl:latest
                  env:
                    - name: DUNGEON
                      value: ${schema.spec.dungeonName}
                    - name: DUNGEON_NS
                      value: ${schema.spec.dungeonNamespace}
                    - name: TARGET
                      value: ${schema.spec.target}
                    - name: DAMAGE
                      value: "${string(schema.spec.damage)}"
                  command: ["/bin/bash", "-c"]
                  args:
                    - |
                      set -e
                      for i in 1 2 3 4 5; do
                        DUNGEON_JSON=$(kubectl get dungeon "$DUNGEON" -n "$DUNGEON_NS" -o json)
                        HERO_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.heroHP // 100')

                        # Check if dungeon is over
                        BOSS_HP_CHECK=$(echo "$DUNGEON_JSON" | jq -r '.spec.bossHP // 1')
                        ALL_DEAD=$(echo "$DUNGEON_JSON" | jq '[.spec.monsterHP[] | select(. > 0)] | length')
                        if [ "$HERO_HP" -le 0 ]; then
                          echo "Dungeon over: hero defeated. No further actions allowed."
                          exit 0
                        fi
                        if [ "$BOSS_HP_CHECK" -le 0 ] && [ "$ALL_DEAD" -eq 0 ]; then
                          echo "Dungeon over: victory. No further actions allowed."
                          exit 0
                        fi

                        HERO_CLASS=$(echo "$DUNGEON_JSON" | jq -r '.spec.heroClass // "warrior"')
                        HERO_MANA=$(echo "$DUNGEON_JSON" | jq -r '.spec.heroMana // 0')
                        DIFFICULTY=$(echo "$DUNGEON_JSON" | jq -r '.spec.difficulty // "normal"')
                        TAUNT_ACTIVE=$(echo "$DUNGEON_JSON" | jq -r '.spec.tauntActive // 0')
                        BACKSTAB_CD=$(echo "$DUNGEON_JSON" | jq -r '.spec.backstabCooldown // 0')
                        MODIFIER=$(echo "$DUNGEON_JSON" | jq -r '.spec.modifier // "none"')
                        INVENTORY=$(echo "$DUNGEON_JSON" | jq -r '.spec.inventory // ""')
                        WEAPON_BONUS=$(echo "$DUNGEON_JSON" | jq -r '.spec.weaponBonus // 0')
                        WEAPON_USES=$(echo "$DUNGEON_JSON" | jq -r '.spec.weaponUses // 0')
                        ARMOR_BONUS=$(echo "$DUNGEON_JSON" | jq -r '.spec.armorBonus // 0')
                        POISON_TURNS=$(echo "$DUNGEON_JSON" | jq -r '.spec.poisonTurns // 0')
                        BURN_TURNS=$(echo "$DUNGEON_JSON" | jq -r '.spec.burnTurns // 0')
                        STUN_TURNS=$(echo "$DUNGEON_JSON" | jq -r '.spec.stunTurns // 0')

                        # Apply DoT at start of turn
                        DOT_NOTE=""
                        if [ "$POISON_TURNS" -gt 0 ]; then
                          HERO_HP=$((HERO_HP - 5))
                          POISON_TURNS=$((POISON_TURNS - 1))
                          DOT_NOTE="Poison -5 HP. "
                        fi
                        if [ "$BURN_TURNS" -gt 0 ]; then
                          HERO_HP=$((HERO_HP - 8))
                          BURN_TURNS=$((BURN_TURNS - 1))
                          DOT_NOTE="$DOT_NOTE""Burn -8 HP. "
                        fi
                        if [ "$HERO_HP" -lt 0 ]; then HERO_HP=0; fi
                        EFFECT_PATCH=",\"poisonTurns\":$POISON_TURNS,\"burnTurns\":$BURN_TURNS"

                        # Check stun
                        IS_STUNNED=false
                        if [ "$STUN_TURNS" -gt 0 ]; then
                          IS_STUNNED=true
                          STUN_TURNS=$((STUN_TURNS - 1))
                          DOT_NOTE="$DOT_NOTE""STUNNED! "
                        fi
                        EFFECT_PATCH="$EFFECT_PATCH,\"stunTurns\":$STUN_TURNS"

                        # Decrement backstab cooldown each turn
                        if [ "$BACKSTAB_CD" -gt 0 ]; then BACKSTAB_CD=$((BACKSTAB_CD - 1)); fi

                        MANA_PATCH=""
                        EXTRA_PATCH=""
                        CLASS_NOTE=""
                        HERO_ACTION=""
                        ENEMY_ACTION=""

                        INVENTORY_PATCH=""
                        WEAPON_PATCH=""

                        # === USE ITEM ===
                        if echo "$TARGET" | grep -q "^use-"; then
                          ITEM_TYPE=$(echo "$TARGET" | sed 's/^use-//')
                          if ! echo ",$INVENTORY," | grep -q ",$ITEM_TYPE,"; then
                            echo "Item $ITEM_TYPE not in inventory"; exit 1
                          fi
                          # Remove first occurrence from inventory
                          NEW_INV=$(echo "$INVENTORY" | sed "s/$ITEM_TYPE//" | sed 's/,,/,/g' | sed 's/^,//;s/,$//')
                          case "$ITEM_TYPE" in
                            hppotion-common) HEAL=20 ;;
                            hppotion-rare) HEAL=40 ;;
                            hppotion-epic) HEAL=999 ;;
                            manapotion-common) HEAL=0; MANA_ADD=2 ;;
                            manapotion-rare) HEAL=0; MANA_ADD=3 ;;
                            manapotion-epic) HEAL=0; MANA_ADD=5 ;;
                            *) echo "Unknown item $ITEM_TYPE"; exit 1 ;;
                          esac
                          MAX_HP=100
                          case "$HERO_CLASS" in warrior) MAX_HP=150 ;; mage) MAX_HP=80 ;; rogue) MAX_HP=100 ;; esac
                          MANA_ADD_VAL=0
                          if [ -n "$MANA_ADD" ]; then MANA_ADD_VAL=$MANA_ADD; fi
                          if [ "$MANA_ADD_VAL" -gt 0 ]; then
                            NEW_MANA=$((HERO_MANA + MANA_ADD))
                            if [ "$NEW_MANA" -gt 5 ]; then NEW_MANA=5; fi
                            HERO_ACTION="Used $ITEM_TYPE! Mana: $HERO_MANA -> $NEW_MANA"
                            PATCH="{\"spec\":{\"heroMana\":$NEW_MANA,\"inventory\":\"$NEW_INV\",\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"Item used\"}}"
                          else
                            NEW_HP=$((HERO_HP + HEAL))
                            if [ "$NEW_HP" -gt "$MAX_HP" ]; then NEW_HP=$MAX_HP; fi
                            HERO_ACTION="Used $ITEM_TYPE! HP: $HERO_HP -> $NEW_HP"
                            PATCH="{\"spec\":{\"heroHP\":$NEW_HP,\"inventory\":\"$NEW_INV\",\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"Item used\"}}"
                          fi
                          echo "$HERO_ACTION"
                          if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                            echo "Item used!"; exit 0
                          fi
                          echo "Conflict, retrying ($i/5)..."; sleep $i; continue
                        fi

                        # === EQUIP ITEM ===
                        if echo "$TARGET" | grep -q "^equip-"; then
                          ITEM_TYPE=$(echo "$TARGET" | sed 's/^equip-//')
                          if ! echo ",$INVENTORY," | grep -q ",$ITEM_TYPE,"; then
                            echo "Item $ITEM_TYPE not in inventory"; exit 1
                          fi
                          NEW_INV=$(echo "$INVENTORY" | sed "s/$ITEM_TYPE//" | sed 's/,,/,/g' | sed 's/^,//;s/,$//')
                          case "$ITEM_TYPE" in
                            weapon-common) WEAPON_VAL=5; WEAPON_USES_VAL=3 ;; weapon-rare) WEAPON_VAL=10; WEAPON_USES_VAL=3 ;; weapon-epic) WEAPON_VAL=20; WEAPON_USES_VAL=3 ;;
                            armor-common) ARMOR_VAL=10 ;; armor-rare) ARMOR_VAL=20 ;; armor-epic) ARMOR_VAL=30 ;;
                            *) echo "Cannot equip $ITEM_TYPE"; exit 1 ;;
                          esac
                          WEAPON_CHECK=0
                          if [ -n "$WEAPON_VAL" ]; then WEAPON_CHECK=$WEAPON_VAL; fi
                          if [ "$WEAPON_VAL_VAL" -gt 0 ]; then
                            HERO_ACTION="Equipped $ITEM_TYPE! +$WEAPON_VAL damage for $WEAPON_USES_VAL attacks"
                            PATCH="{\"spec\":{\"weaponBonus\":$WEAPON_VAL,\"weaponUses\":$WEAPON_USES_VAL,\"inventory\":\"$NEW_INV\",\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"Item equipped\"}}"
                          else
                            HERO_ACTION="Equipped $ITEM_TYPE! Armor +$ARMOR_VAL pct defense"
                            PATCH="{\"spec\":{\"armorBonus\":$ARMOR_VAL,\"inventory\":\"$NEW_INV\",\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"Item equipped\"}}"
                          fi
                          echo "$HERO_ACTION"
                          if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                            echo "Item equipped!"; exit 0
                          fi
                          echo "Conflict, retrying ($i/5)..."; sleep $i; continue
                        fi

                        # === MAGE HEAL ===
                        if [ "$TARGET" = "hero" ]; then
                          if [ "$HERO_CLASS" != "mage" ]; then
                            echo "Only mage can heal"; exit 1
                          fi
                          if [ "$HERO_MANA" -lt 2 ]; then
                            echo "Not enough mana (need 2, have $HERO_MANA)"; exit 1
                          fi
                          MAX_HP=80
                          HEAL=30
                          NEW_HP=$((HERO_HP + HEAL))
                          if [ "$NEW_HP" -gt "$MAX_HP" ]; then NEW_HP=$MAX_HP; fi
                          HERO_MANA=$((HERO_MANA - 2))
                          HERO_ACTION="Mage heals for $((NEW_HP - HERO_HP)) HP! (Mana: $HERO_MANA)"
                          ENEMY_ACTION="No counter-attack during heal"
                          PATCH="{\"spec\":{\"heroHP\":$NEW_HP,\"heroMana\":$HERO_MANA,\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"$ENEMY_ACTION\"}}"
                          echo "$HERO_ACTION"
                          if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                            echo "Heal complete!"; exit 0
                          fi
                          echo "Conflict, retrying ($i/5)..."; sleep $i; continue
                        fi

                        # === WARRIOR TAUNT (activate buff for next attack) ===
                        if [ "$TARGET" = "activate-taunt" ]; then
                          if [ "$HERO_CLASS" != "warrior" ]; then
                            echo "Only warrior can taunt"; exit 1
                          fi
                          PATCH="{\"spec\":{\"tauntActive\":1,\"lastHeroAction\":\"Warrior activates Taunt! Next attack has 60% counter-attack reduction.\",\"lastEnemyAction\":\"\"}}"
                          if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                            echo "Taunt activated!"; exit 0
                          fi
                          echo "Conflict, retrying ($i/5)..."; sleep $i; continue
                        fi

                        # === ROGUE BACKSTAB (target ends with -backstab) ===
                        IS_BACKSTAB=false
                        REAL_TARGET="$TARGET"
                        if echo "$TARGET" | grep -q "\-backstab$"; then
                          IS_BACKSTAB=true
                          REAL_TARGET=$(echo "$TARGET" | sed 's/-backstab$//')
                          if [ "$HERO_CLASS" != "rogue" ]; then
                            echo "Only rogue can backstab"; exit 1
                          fi
                          ORIG_CD=$(echo "$DUNGEON_JSON" | jq -r '.spec.backstabCooldown // 0')
                          if [ "$ORIG_CD" -gt 0 ]; then
                            echo "Backstab on cooldown ($ORIG_CD turns)"; exit 1
                          fi
                          BACKSTAB_CD=3
                        fi

                        # Roll dice server-side based on difficulty
                        if [ "$DAMAGE" -gt 0 ] 2>/dev/null; then
                          BASE_DAMAGE=$DAMAGE
                        else
                          case "$DIFFICULTY" in
                            easy)   DICE_COUNT=2; DICE_SIDES=8; DICE_MOD=5 ;;
                            hard)   DICE_COUNT=3; DICE_SIDES=10; DICE_MOD=10 ;;
                            *)      DICE_COUNT=2; DICE_SIDES=10; DICE_MOD=8 ;;
                          esac
                          if echo "$REAL_TARGET" | grep -q "boss"; then
                            DICE_COUNT=$((DICE_COUNT + 1))
                            DICE_SIDES=$((DICE_SIDES + 2))
                            DICE_MOD=$((DICE_MOD + 2))
                          fi
                          BASE_DAMAGE=$DICE_MOD
                          for dc in $(seq 1 $DICE_COUNT); do
                            BASE_DAMAGE=$((BASE_DAMAGE + (RANDOM % DICE_SIDES) + 1))
                          done
                        fi

                        # Apply class damage modifier
                        EFFECTIVE_DAMAGE=$BASE_DAMAGE
                        if [ "$IS_BACKSTAB" = "true" ]; then
                          EFFECTIVE_DAMAGE=$((BASE_DAMAGE * 3))
                          CLASS_NOTE=" (Backstab 3x!)"
                        elif [ "$HERO_CLASS" = "mage" ]; then
                          if [ "$HERO_MANA" -gt 0 ]; then
                            if echo "$REAL_TARGET" | grep -q "boss"; then
                              EFFECTIVE_DAMAGE=$((BASE_DAMAGE * 3 / 2))
                              CLASS_NOTE=" (Mage critical!)"
                            fi
                            HERO_MANA=$((HERO_MANA - 1))
                            MANA_PATCH=",\"heroMana\":$HERO_MANA"
                          else
                            CLASS_NOTE=" (No mana!)"
                            EFFECTIVE_DAMAGE=$((BASE_DAMAGE / 2))
                          fi
                        elif [ "$HERO_CLASS" = "rogue" ]; then
                          EFFECTIVE_DAMAGE=$((BASE_DAMAGE * 6 / 5))
                          CLASS_NOTE=" (Rogue precision!)"
                        fi

                        # Taunt: if active, will reduce counter-attack damage by 60% this turn
                        TAUNT_NOTE=""
                        if [ "$TAUNT_ACTIVE" -eq 1 ]; then
                          TAUNT_NOTE=" [ðŸ›¡ï¸ Taunt active: -60% counter dmg]"
                          TAUNT_ACTIVE=2  # Set to cooldown (2 = cooling down, decremented each turn)
                        elif [ "$TAUNT_ACTIVE" -gt 1 ]; then
                          TAUNT_ACTIVE=$((TAUNT_ACTIVE - 1))  # Decrement cooldown
                        fi

                        # Apply modifier to hero damage
                        if [ "$MODIFIER" = "curse-darkness" ]; then
                          EFFECTIVE_DAMAGE=$((EFFECTIVE_DAMAGE * 3 / 4))
                          CLASS_NOTE="$CLASS_NOTE [Curse: -25% dmg]"
                        elif [ "$MODIFIER" = "blessing-strength" ]; then
                          EFFECTIVE_DAMAGE=$((EFFECTIVE_DAMAGE * 3 / 2))
                          CLASS_NOTE="$CLASS_NOTE [Blessing: +50% dmg]"
                        elif [ "$MODIFIER" = "blessing-fortune" ]; then
                          CRIT_ROLL=$((RANDOM % 100))
                          if [ "$CRIT_ROLL" -lt 20 ]; then
                            EFFECTIVE_DAMAGE=$((EFFECTIVE_DAMAGE * 2))
                            CLASS_NOTE="$CLASS_NOTE [CRIT! 2x dmg]"
                          fi
                        fi

                        # Apply weapon bonus
                        if [ "$WEAPON_USES" -gt 0 ]; then
                          EFFECTIVE_DAMAGE=$((EFFECTIVE_DAMAGE + WEAPON_BONUS))
                          WEAPON_USES=$((WEAPON_USES - 1))
                          CLASS_NOTE="$CLASS_NOTE [+$WEAPON_BONUS wpn]"
                          if [ "$WEAPON_USES" -eq 0 ]; then
                            WEAPON_BONUS=0
                            CLASS_NOTE="$CLASS_NOTE [weapon broke!]"
                          fi
                        fi
                        WEAPON_PATCH=",\"weaponBonus\":$WEAPON_BONUS,\"weaponUses\":$WEAPON_USES"

                        # If stunned, skip hero damage
                        if [ "$IS_STUNNED" = "true" ]; then
                          EFFECTIVE_DAMAGE=0
                          CLASS_NOTE=" STUNNED!"
                        fi

                        # Calculate hero's attack on target
                        if echo "$REAL_TARGET" | grep -q "boss"; then
                          OLD_HP=$(echo "$DUNGEON_JSON" | jq -r '.spec.bossHP')
                          NEW_HP=$((OLD_HP - EFFECTIVE_DAMAGE))
                          if [ "$NEW_HP" -lt 0 ]; then NEW_HP=0; fi
                          # Boss counter-attack
                          case "$DIFFICULTY" in
                            easy)   COUNTER=2 ;; normal) COUNTER=10 ;; hard) COUNTER=15 ;;
                          esac
                          if [ "$NEW_HP" -gt 0 ]; then
                            # Apply modifier to boss counter
                            if [ "$MODIFIER" = "curse-fury" ]; then
                              COUNTER=$((COUNTER * 2))
                            elif [ "$MODIFIER" = "blessing-resilience" ]; then
                              COUNTER=$((COUNTER / 2))
                            fi
                            # Apply armor bonus
                            if [ "$ARMOR_BONUS" -gt 0 ]; then
                              COUNTER=$((COUNTER * (100 - ARMOR_BONUS) / 100))
                            fi
                            if [ "$HERO_CLASS" = "warrior" ]; then
                              COUNTER=$((COUNTER * 4 / 5))
                            elif [ "$HERO_CLASS" = "rogue" ]; then
                              DODGE_ROLL=$((RANDOM % 100))
                              if [ "$DODGE_ROLL" -lt 30 ]; then
                                COUNTER=0
                                CLASS_NOTE="$CLASS_NOTE Rogue dodged!"
                              fi
                            fi
                            # Taunt reduction
                            if [ "$TAUNT_ACTIVE" -eq 2 ] && [ "$COUNTER" -gt 0 ]; then
                              COUNTER=$((COUNTER * 2 / 5))
                            fi
                            HERO_HP=$((HERO_HP - COUNTER))
                          fi
                          if [ "$HERO_HP" -lt 0 ]; then HERO_HP=0; fi
                          HP_PATCH="\"bossHP\":$NEW_HP"
                          # Boss guaranteed loot drop
                          if [ "$NEW_HP" -eq 0 ]; then
                            RARITY_ROLL=$((RANDOM % 2))
                            if [ "$RARITY_ROLL" -eq 0 ]; then RARITY="rare"; else RARITY="epic"; fi
                            TYPE_ROLL=$((RANDOM % 3))
                            case "$TYPE_ROLL" in 0) ITEM="weapon-$RARITY" ;; 1) ITEM="armor-$RARITY" ;; 2) ITEM="hppotion-$RARITY" ;; esac
                            if [ -n "$INVENTORY" ]; then INVENTORY="$INVENTORY,$ITEM"; else INVENTORY="$ITEM"; fi
                            INVENTORY_PATCH=",\"inventory\":\"$INVENTORY\""
                            CLASS_NOTE="$CLASS_NOTE Boss dropped $ITEM!"
                          fi
                        else
                          IDX=$(echo "$REAL_TARGET" | grep -oE '[0-9]+$')
                          OLD_HP=$(echo "$DUNGEON_JSON" | jq -r ".spec.monsterHP[$IDX]")
                          NEW_HP=$((OLD_HP - EFFECTIVE_DAMAGE))
                          if [ "$NEW_HP" -lt 0 ]; then NEW_HP=0; fi
                          HP_ARRAY=$(echo "$DUNGEON_JSON" | jq ".spec.monsterHP[$IDX] = $NEW_HP | .spec.monsterHP")
                          # Mage mana regen on kill
                          if [ "$NEW_HP" -eq 0 ] && [ "$HERO_CLASS" = "mage" ] && [ "$HERO_MANA" -lt 5 ]; then
                            HERO_MANA=$((HERO_MANA + 1))
                            MANA_PATCH=",\"heroMana\":$HERO_MANA"
                            CLASS_NOTE="$CLASS_NOTE +1 mana!"
                          fi
                          # Loot drop on monster kill
                          if [ "$NEW_HP" -eq 0 ]; then
                            DROP_CHANCE=45
                            case "$DIFFICULTY" in easy) DROP_CHANCE=60 ;; normal) DROP_CHANCE=45 ;; hard) DROP_CHANCE=35 ;; esac
                            DROP_ROLL=$((RANDOM % 100))
                            if [ "$DROP_ROLL" -lt "$DROP_CHANCE" ]; then
                              RARITY_ROLL=$((RANDOM % 100))
                              if [ "$RARITY_ROLL" -lt 60 ]; then RARITY="common"
                              elif [ "$RARITY_ROLL" -lt 90 ]; then RARITY="rare"
                              else RARITY="epic"; fi
                              TYPE_ROLL=$((RANDOM % 4))
                              case "$TYPE_ROLL" in
                                0) ITEM="weapon-$RARITY" ;;
                                1) ITEM="armor-$RARITY" ;;
                                2) ITEM="hppotion-$RARITY" ;;
                                3) if [ "$HERO_CLASS" = "mage" ]; then ITEM="manapotion-$RARITY"; else ITEM="hppotion-$RARITY"; fi ;;
                              esac
                              if [ -n "$INVENTORY" ]; then INVENTORY="$INVENTORY,$ITEM"; else INVENTORY="$ITEM"; fi
                              INVENTORY_PATCH=",\"inventory\":\"$INVENTORY\""
                              CLASS_NOTE="$CLASS_NOTE Dropped $ITEM!"
                            fi
                          fi
                          # All alive monsters counter-attack
                          case "$DIFFICULTY" in
                            easy)   COUNTER=2 ;; normal) COUNTER=4 ;; hard) COUNTER=6 ;;
                          esac
                          ALIVE=$(echo "$DUNGEON_JSON" | jq '[.spec.monsterHP[] | select(. > 0)] | length')
                          if [ "$NEW_HP" -eq 0 ] && [ "$ALIVE" -gt 0 ]; then ALIVE=$((ALIVE - 1)); fi
                          TOTAL_COUNTER=$((ALIVE * COUNTER))
                          # Apply modifier to monster counter
                          if [ "$MODIFIER" = "blessing-resilience" ]; then
                            TOTAL_COUNTER=$((TOTAL_COUNTER / 2))
                          fi
                          # Apply armor bonus
                          if [ "$ARMOR_BONUS" -gt 0 ]; then
                            TOTAL_COUNTER=$((TOTAL_COUNTER * (100 - ARMOR_BONUS) / 100))
                          fi
                          if [ "$TOTAL_COUNTER" -gt 0 ]; then
                            if [ "$HERO_CLASS" = "warrior" ]; then
                              TOTAL_COUNTER=$((TOTAL_COUNTER * 4 / 5))
                            elif [ "$HERO_CLASS" = "rogue" ]; then
                              DODGE_ROLL=$((RANDOM % 100))
                              if [ "$DODGE_ROLL" -lt 30 ]; then
                                TOTAL_COUNTER=0
                                CLASS_NOTE="$CLASS_NOTE Rogue dodged!"
                              fi
                            fi
                            # Taunt reduction
                            if [ "$TAUNT_ACTIVE" -eq 2 ] && [ "$TOTAL_COUNTER" -gt 0 ]; then
                              TOTAL_COUNTER=$((TOTAL_COUNTER * 2 / 5))
                            fi
                            HERO_HP=$((HERO_HP - TOTAL_COUNTER))
                          fi
                          if [ "$HERO_HP" -lt 0 ]; then HERO_HP=0; fi
                          HP_PATCH="\"monsterHP\":$HP_ARRAY"
                        fi

                        # Roll for status effects from counter-attacks
                        EFFECT_NOTE=""
                        if echo "$REAL_TARGET" | grep -q "boss"; then
                          if [ "$NEW_HP" -gt 0 ]; then
                            # Boss can inflict stun (15%) or burn (25%) â€” only if not already active
                            EFFECT_ROLL=$((RANDOM % 100))
                            if [ "$EFFECT_ROLL" -lt 15 ] && [ "$STUN_TURNS" -eq 0 ]; then
                              STUN_TURNS=1
                              EFFECT_NOTE=" Boss inflicts STUN! (1 turn)"
                            elif [ "$EFFECT_ROLL" -lt 40 ] && [ "$BURN_TURNS" -eq 0 ]; then
                              BURN_TURNS=2
                              EFFECT_NOTE=" Boss inflicts BURN! (2 turns, -8 HP/turn)"
                            fi
                          fi
                        else
                          if [ "$ALIVE" -gt 0 ] 2>/dev/null; then
                            # Monsters can inflict poison (20%) â€” only if not already poisoned
                            if [ "$POISON_TURNS" -eq 0 ]; then
                              EFFECT_ROLL=$((RANDOM % 100))
                              if [ "$EFFECT_ROLL" -lt 20 ]; then
                                POISON_TURNS=3
                                EFFECT_NOTE=" Monsters inflict POISON! (3 turns, -5 HP/turn)"
                              fi
                            fi
                          fi
                        fi
                        EFFECT_PATCH=",\"poisonTurns\":$POISON_TURNS,\"burnTurns\":$BURN_TURNS,\"stunTurns\":$STUN_TURNS"

                        HERO_ACTION="$DOT_NOTE""Hero ($HERO_CLASS) deals $EFFECTIVE_DAMAGE damage to $REAL_TARGET (HP: $OLD_HP -> $NEW_HP)$CLASS_NOTE"

                        if echo "$REAL_TARGET" | grep -q "boss"; then
                          if [ "$NEW_HP" -gt 0 ]; then
                            ENEMY_ACTION="Boss strikes back for $COUNTER damage! (Hero HP: $HERO_HP)"
                          else
                            ENEMY_ACTION="Boss defeated!"
                          fi
                        else
                          if [ "$TOTAL_COUNTER" -gt 0 ] 2>/dev/null; then
                            ENEMY_ACTION="$ALIVE monsters counter-attack for $TOTAL_COUNTER total damage! (Hero HP: $HERO_HP)"
                          elif [ "$NEW_HP" -eq 0 ]; then
                            ENEMY_ACTION="Monster slain! No remaining counter-attack."
                          else
                            ENEMY_ACTION="Monsters counter-attack absorbed!"
                          fi
                        fi

                        PATCH="{\"spec\":{$HP_PATCH,\"heroHP\":$HERO_HP,\"tauntActive\":$TAUNT_ACTIVE,\"backstabCooldown\":$BACKSTAB_CD,\"lastHeroAction\":\"$HERO_ACTION\",\"lastEnemyAction\":\"$ENEMY_ACTION$EFFECT_NOTE\"$MANA_PATCH$WEAPON_PATCH$INVENTORY_PATCH$EFFECT_PATCH}}"

                        echo "$HERO_ACTION"
                        echo "$ENEMY_ACTION"

                        if kubectl patch dungeon "$DUNGEON" -n "$DUNGEON_NS" --type=merge -p "$PATCH" 2>&1; then
                          echo "Turn complete!"
                          exit 0
                        fi

                        echo "Conflict, retrying ($i/5)..."
                        sleep $i
                      done
                      echo "Attack failed after retries"
                      exit 1
