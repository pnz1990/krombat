apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: dungeon-graph
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  schema:
    apiVersion: v1alpha1
    kind: Dungeon
    group: game.k8s.example
    spec:
      monsters: integer | default=3 minimum=1 maximum=10
      difficulty: string | default="normal" enum=easy,normal,hard
      monsterHP: "[]integer"
      bossHP: integer | default=0
      heroHP: integer | default=100
      heroClass: string | default="warrior" enum=warrior,mage,rogue
      heroMana: integer | default=0
      tauntActive: integer | default=0
      backstabCooldown: integer | default=0
      modifier: string | default="none"
      inventory: string | default=""
      weaponBonus: integer | default=0
      weaponUses: integer | default=0
      armorBonus: integer | default=0
      shieldBonus: integer | default=0
      poisonTurns: integer | default=0
      burnTurns: integer | default=0
      stunTurns: integer | default=0
      treasureOpened: integer | default=0
      lastHeroAction: string | default=""
      lastEnemyAction: string | default=""
    status:
      livingMonsters: "${size(monsterCRs.filter(m, m.status.?entityState.orValue('alive') == 'alive'))}"
      bossState: "${bossCR.status.?entityState.orValue('pending')}"
      victory: "${bossCR.status.?entityState.orValue('pending') == 'defeated'}"
      defeat: "${heroCR.status.?entityState.orValue('alive') == 'defeated'}"
      loot: "${treasureCR.status.?loot.orValue('')}"
      treasureState: "${treasureCR.status.?treasureState.orValue('unopened')}"
      modifier: "${modifierCR.status.?effect.orValue('No modifier')}"
      modifierType: "${modifierCR.status.?modifierType.orValue('none')}"
      maxHeroHP: "${heroCR.status.?maxHP.orValue('100')}"
      maxMonsterHP: "${gameConfig.data.maxMonsterHP}"
      maxBossHP: "${gameConfig.data.maxBossHP}"
      diceFormula: "${gameConfig.data.diceFormula}"
      monsterCounter: "${gameConfig.data.monsterCounter}"
      bossCounter: "${gameConfig.data.bossCounter}"

  resources:
    # --- Namespace per dungeon ---
    - id: ns
      template:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: ${schema.metadata.name}
          labels:
            game.k8s.example/dungeon: ${schema.metadata.name}

    # --- Hero CR (depends on ns via namespace reference) ---
    - id: heroCR
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Hero
        metadata:
          name: "${schema.metadata.name + '-hero'}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          hp: ${schema.spec.heroHP}
          difficulty: ${schema.spec.difficulty}
          heroClass: ${schema.spec.heroClass}
          mana: ${schema.spec.heroMana}

    # --- Monster CRs (depends on ns via namespace reference) ---
    - id: monsterCRs
      forEach:
        - idx: ${lists.range(size(schema.spec.monsterHP))}
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Monster
        metadata:
          name: "${schema.metadata.name + '-monster-' + string(idx)}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          index: ${idx}
          hp: ${schema.spec.monsterHP[idx]}
          difficulty: ${schema.spec.difficulty}

    # --- Boss CR (depends on ns via namespace reference) ---
    - id: bossCR
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Boss
        metadata:
          name: "${schema.metadata.name + '-boss'}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          hp: ${schema.spec.bossHP}
          difficulty: ${schema.spec.difficulty}
          monstersAlive: "${size(schema.spec.monsterHP.filter(hp, hp > 0))}"

    # --- Treasure CR (depends on ns via namespace reference) ---
    - id: treasureCR
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Treasure
        metadata:
          name: "${schema.metadata.name + '-treasure'}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          opened: ${schema.spec.treasureOpened}

    # --- Modifier CR (conditional: only created when modifier is not "none") ---
    - id: modifierCR
      includeWhen:
        - ${schema.spec.modifier != "none"}
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Modifier
        metadata:
          name: "${schema.metadata.name + '-modifier'}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          modifierType: ${schema.spec.modifier}

    # --- Game config (difficulty-derived values) ---
    - id: gameConfig
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: "${schema.metadata.name + '-config'}"
          namespace: ${ns.metadata.name}
        data:
          maxMonsterHP: "${schema.spec.difficulty == 'easy' ? '30' : schema.spec.difficulty == 'hard' ? '80' : '50'}"
          maxBossHP: "${schema.spec.difficulty == 'easy' ? '200' : schema.spec.difficulty == 'hard' ? '800' : '400'}"
          diceFormula: "${schema.spec.difficulty == 'easy' ? '1d20+2' : schema.spec.difficulty == 'hard' ? '3d20+5' : '2d12+4'}"
          monsterCounter: "${schema.spec.difficulty == 'easy' ? '1' : schema.spec.difficulty == 'hard' ? '3' : '2'}"
          bossCounter: "${schema.spec.difficulty == 'easy' ? '3' : schema.spec.difficulty == 'hard' ? '8' : '5'}"

    # --- ResourceQuota ---
    - id: quota
      template:
        apiVersion: v1
        kind: ResourceQuota
        metadata:
          name: dungeon-quota
          namespace: ${ns.metadata.name}
        spec:
          hard:
            pods: "20"
            requests.cpu: "1"
            requests.memory: "1Gi"

    # --- NetworkPolicy ---
    - id: netpol
      template:
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: dungeon-default-deny
          namespace: ${ns.metadata.name}
        spec:
          podSelector: {}
          policyTypes:
            - Ingress
          ingress:
            - from:
                - namespaceSelector:
                    matchLabels:
                      kubernetes.io/metadata.name: rpg-system
