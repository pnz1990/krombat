apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: dungeon-graph
spec:
  schema:
    apiVersion: v1alpha1
    kind: Dungeon
    group: game.k8s.example
    spec:
      monsters: integer | default=3 minimum=1 maximum=10
      difficulty: string | default="normal" enum=easy,normal,hard
      monsterHP: "[]integer"
      bossHP: integer | default=0
    status:
      livingMonsters: "${size(monsterPods.filter(m, m.metadata.labels['game.k8s.example/state'] == 'alive'))}"
      bossState: "${bossPod.metadata.labels['game.k8s.example/state']}"
      victory: "${bossPod.metadata.labels['game.k8s.example/state'] == 'defeated'}"
      loot: "${'Treasure code: ' + ns.metadata.name + '-LOOT'}"

  resources:
    # --- Namespace per dungeon ---
    - id: ns
      template:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: ${schema.metadata.name}
          labels:
            game.k8s.example/dungeon: ${schema.metadata.name}

    # --- Monster pods (dynamic count from monsterHP array) ---
    - id: monsterPods
      forEach:
        - idx: ${lists.range(size(schema.spec.monsterHP))}
      template:
        apiVersion: v1
        kind: Pod
        metadata:
          name: "${schema.metadata.name + '-monster-' + string(idx)}"
          namespace: ${schema.metadata.name}
          labels:
            game.k8s.example/dungeon: ${schema.metadata.name}
            game.k8s.example/entity: monster
            game.k8s.example/state: "${schema.spec.monsterHP[idx] > 0 ? 'alive' : 'dead'}"
          annotations:
            game.k8s.example/hp: "${string(schema.spec.monsterHP[idx])}"
        spec:
          containers:
            - name: monster
              image: registry.k8s.io/pause:3.10
              resources:
                requests:
                  cpu: "10m"
                  memory: "16Mi"

    # --- Boss pod ---
    - id: bossPod
      template:
        apiVersion: v1
        kind: Pod
        metadata:
          name: "${schema.metadata.name + '-boss'}"
          namespace: ${schema.metadata.name}
          labels:
            game.k8s.example/dungeon: ${schema.metadata.name}
            game.k8s.example/entity: boss
            game.k8s.example/state: "${schema.spec.bossHP > 0 ? (size(schema.spec.monsterHP.filter(hp, hp > 0)) == 0 ? 'ready' : 'pending') : 'defeated'}"
          annotations:
            game.k8s.example/hp: "${string(schema.spec.bossHP)}"
        spec:
          containers:
            - name: boss
              image: registry.k8s.io/pause:3.10
              resources:
                requests:
                  cpu: "10m"
                  memory: "16Mi"

    # --- Treasure ---
    - id: treasure
      template:
        apiVersion: v1
        kind: Secret
        metadata:
          name: "${schema.metadata.name + '-treasure'}"
          namespace: ${schema.metadata.name}
          labels:
            game.k8s.example/dungeon: ${schema.metadata.name}
            game.k8s.example/entity: treasure
        stringData:
          loot: "${'Treasure code: ' + schema.metadata.name + '-LOOT'}"

    # --- ResourceQuota ---
    - id: quota
      template:
        apiVersion: v1
        kind: ResourceQuota
        metadata:
          name: dungeon-quota
          namespace: ${schema.metadata.name}
        spec:
          hard:
            pods: "20"
            requests.cpu: "1"
            requests.memory: "1Gi"

    # --- NetworkPolicy ---
    - id: netpol
      template:
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: dungeon-default-deny
          namespace: ${schema.metadata.name}
        spec:
          podSelector: {}
          policyTypes:
            - Ingress
          ingress:
            - from:
                - namespaceSelector:
                    matchLabels:
                      kubernetes.io/metadata.name: rpg-system
