apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: dungeon-graph
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  schema:
    apiVersion: v1alpha1
    kind: Dungeon
    group: game.k8s.example
    spec:
      monsters: integer | default=3 minimum=1 maximum=10
      difficulty: string | default="normal" enum=easy,normal,hard
      monsterHP: "[]integer"
      bossHP: integer | default=0
      heroHP: integer | default=100
    status:
      livingMonsters: "${size(monsterCRs.filter(m, m.status.?entityState.orValue('alive') == 'alive'))}"
      bossState: "${bossCR.status.?entityState.orValue('pending')}"
      victory: "${bossCR.status.?entityState.orValue('pending') == 'defeated'}"
      defeat: "${heroCR.status.?entityState.orValue('alive') == 'defeated'}"
      loot: "${treasureCR.status.?loot.orValue('')}"

  resources:
    # --- Namespace per dungeon ---
    - id: ns
      template:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: ${schema.metadata.name}
          labels:
            game.k8s.example/dungeon: ${schema.metadata.name}

    # --- Hero CR (depends on ns via namespace reference) ---
    - id: heroCR
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Hero
        metadata:
          name: "${schema.metadata.name + '-hero'}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          hp: ${schema.spec.heroHP}
          difficulty: ${schema.spec.difficulty}

    # --- Monster CRs (depends on ns via namespace reference) ---
    - id: monsterCRs
      forEach:
        - idx: ${lists.range(size(schema.spec.monsterHP))}
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Monster
        metadata:
          name: "${schema.metadata.name + '-monster-' + string(idx)}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          index: ${idx}
          hp: ${schema.spec.monsterHP[idx]}
          difficulty: ${schema.spec.difficulty}

    # --- Boss CR (depends on ns via namespace reference) ---
    - id: bossCR
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Boss
        metadata:
          name: "${schema.metadata.name + '-boss'}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}
          hp: ${schema.spec.bossHP}
          difficulty: ${schema.spec.difficulty}
          monstersAlive: "${size(schema.spec.monsterHP.filter(hp, hp > 0))}"

    # --- Treasure CR (depends on ns via namespace reference) ---
    - id: treasureCR
      template:
        apiVersion: game.k8s.example/v1alpha1
        kind: Treasure
        metadata:
          name: "${schema.metadata.name + '-treasure'}"
          namespace: ${ns.metadata.name}
        spec:
          dungeonName: ${schema.metadata.name}

    # --- ResourceQuota ---
    - id: quota
      template:
        apiVersion: v1
        kind: ResourceQuota
        metadata:
          name: dungeon-quota
          namespace: ${ns.metadata.name}
        spec:
          hard:
            pods: "20"
            requests.cpu: "1"
            requests.memory: "1Gi"

    # --- NetworkPolicy ---
    - id: netpol
      template:
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: dungeon-default-deny
          namespace: ${ns.metadata.name}
        spec:
          podSelector: {}
          policyTypes:
            - Ingress
          ingress:
            - from:
                - namespaceSelector:
                    matchLabels:
                      kubernetes.io/metadata.name: rpg-system
